<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gulf Coast — Structural Estimating Form</title>
  <style>
    :root{ --bg:#0a1630; --panel:#0f2245; --teal:#23c0d9; --text:#ecf5ff;
           --muted:#9fb3d9; --ring:#23c0d99a; --ok:#38d39f; --err:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#09132a);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .card{background:var(--panel);border:1px solid #132a59;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:24px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:24px}
    header img{height:56px}
    h1{margin:0;color:var(--teal);font-weight:800;letter-spacing:.2px}
    p.subtitle{margin:.25rem 0 0;color:var(--muted)}
    .row{border-top:1px dashed #2a4e9a;padding-top:14px;margin-top:14px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(180px,1fr));gap:14px}
    .grid-4{display:grid;grid-template-columns:repeat(4,minmax(150px,1fr));gap:14px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:.85rem;color:var(--muted)}
    select,input{background:#0b1d3d;border:1px solid #1a3570;color:var(--text);padding:10px 12px;border-radius:12px;outline:none;transition:.15s;width:100%}
    select:focus,input:focus{border-color:var(--teal);box-shadow:0 0 0 3px var(--ring)}
    .line-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn{background:var(--teal);color:#002333}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid #2a4e9a}
    .btn-danger{background:#ff6b6b;color:#001926}
    .result{margin-top:12px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat{background:#0a1c3a;border:1px solid #142b5a;border-radius:12px;padding:12px}
    .stat .k{font-size:.8rem;color:var(--muted)}
    .stat .v{font-size:1.1rem;font-weight:800}
    .section-title{margin:22px 0 10px;color:var(--teal);font-size:1.1rem}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:10px;border-bottom:1px solid #102550}
    th{background:#0e2146;color:var(--text);text-align:left}
    td.num{text-align:right}
    .msg{margin-top:12px;font-size:.9rem}
    .msg.ok{color:var(--ok)} .msg.err{color:var(--err)}
    footer{margin:26px 0 4px;color:var(--muted);font-size:.8rem;text-align:center}

    /* Hide Current Lines (B–K) block */
    #currentLinesSection {
      display: none !important;
    }

    /* Clean print layout for the summary view */
    @media print {
      body{ background:#fff; color:#000; }
      .card, .result, .line-actions, header img { box-shadow:none !important }
      .line-actions, #linesContainer, #totalsPanel + .section-title, 
      #loadSheetLinesBtn, #sheetLinesBody, footer, .msg { display:none !important; }
      .card{ border:none }
      table, th, td { border:1px solid #ccc; border-collapse:collapse }
      th, td { color:#000 !important }
      a { color:#000 !important; text-decoration:none }
      @page { margin: 16mm }
    }

    @media (max-width:900px){
      .result{grid-template-columns:repeat(2,1fr)}
      .grid-4{grid-template-columns:repeat(2,minmax(150px,1fr))}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img src="LOGO_URL" alt="Gulf Coast Supply & Manufacturing" onerror="this.style.display='none'">
        <div>
          <h1>Gulf Coast • Internal Cost Calculator</h1>
          <p class="subtitle">Live numbers from Google Sheets price table. Pick options, enter length, get cost.</p>
        </div>
      </header>

      <div class="line-actions" style="justify-content:space-between;margin-bottom:6px">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-ghost" id="reloadOptionsBtn">Reload Options</button>
          <button class="btn-ghost" id="addLineBtn">Add line</button>
          <button class="btn-ghost" id="printBtn">Print / Save PDF</button>
        </div>
        <div>
          <button class="btn" id="calcAllBtn">Calculate All</button>
        </div>
      </div>

      <!-- Lines container: starts with ONE row -->
      <div id="linesContainer"></div>

      <!-- Totals -->
      <div class="result" id="totalsPanel" style="margin-top:10px">
        <div class="stat">
          <div class="k">Subtotal (all lines)</div>
          <div class="v" id="subtotal">$0.00</div>
        </div>
      </div>

      <!-- Your selections (live, from this page) -->
      <h2 class="section-title">Your Selections</h2>
      <div class="card" style="background:#0b1d3d;border-radius:14px;padding:0;overflow:auto;border:1px solid #1a3570">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Component</th><th>Color</th><th>Gauge</th><th>Flange</th>
              <th class="num">Qty</th><th class="num">Feet</th><th class="num">Inches</th>
              <th class="num">Total Inches</th><th class="num">Extended</th>
            </tr>
          </thead>
          <tbody id="liveSummaryBody"></tbody>
        </table>
      </div>

      <!-- Public view from sheet (B–K) – now wrapped & hidden -->
      <div id="currentLinesSection">
        <h2 class="section-title">Current Lines (B–K)</h2>
        <div class="line-actions" style="justify-content:flex-start;margin:8px 0 12px">
          <button class="btn-ghost" id="loadSheetLinesBtn">Reload Lines</button>
        </div>
        <div class="card" style="background:#0b1d3d;border-radius:14px;padding:0;overflow:auto;border:1px solid #1a3570">
          <table>
            <thead>
              <tr>
                <th>Price Code</th><th>Component</th><th>Color</th><th>Gauge</th><th>Flange</th>
                <th class="num">Qty</th><th class="num">Feet</th><th class="num">Inches</th>
                <th class="num">Total Inches</th><th class="num">Est. Cost</th>
              </tr>
            </thead>
            <tbody id="sheetLinesBody"></tbody>
          </table>
        </div>
      </div>

      <div class="msg" id="msg"></div>
      <footer>Only B–K are intended for public viewing. Pricing table remains hidden/private.</footer>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxd7mrAzpNvDZYN59riprG6keK36ZOUx-9TBlhCp3MnlKh1akP2DQaT9SxcmkJ21x2_VA/exec';
    const MAX_LINES = 20;
    const POST_TIMEOUT_MS = 12000;

    const $ = id => document.getElementById(id);
    const qs = (el,sel) => el.querySelector(sel);

    let lineCount = 0;                 // dynamic number of rows
    let extValues = [];                // extended per row, indexed by (line-1)
    let cachedOptions = {components:[], colors:[], gauges:[], flanges:[]};

    function setMsg(txt, ok){
      const m = $('msg'); m.textContent = txt || '';
      m.className = 'msg ' + (ok===true ? 'ok' : ok===false ? 'err' : '');
    }
    function updateTotals(){
      const sum = extValues.reduce((a,b)=>a + (Number(b)||0), 0);
      $('subtotal').textContent = '$' + sum.toFixed(2);
    }
    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error('Network error: ' + r.status);
      const j = await r.json();
      if(j.error) throw new Error(j.error);
      return j;
    }
    async function postJSON(url, bodyObj){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), POST_TIMEOUT_MS);
      try{
        const r = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(bodyObj),
          signal: ctrl.signal
        });
        if(!r.ok) throw new Error('Network error: ' + r.status);
        const j = await r.json();
        if(j.error) throw new Error(j.error);
        return j;
      } finally { clearTimeout(t); }
    }

    // ----- render a single line -----
    function renderLine(idx){
      const wrap = $('linesContainer');
      const row = document.createElement('section');
      row.className = 'row';
      row.dataset.idx = idx;
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <div style="opacity:.8">Line ${idx}</div>
          <div class="line-actions">
            <button class="btn-ghost" data-calc-one>Calculate line ${idx}</button>
            <button class="btn-danger" data-remove>Remove</button>
          </div>
        </div>
        <div class="grid-4">
          <div class="field"><label>Component</label><select id="component-${idx}"></select></div>
          <div class="field"><label>Color</label><select id="color-${idx}"></select></div>
          <div class="field"><label>Gauge</label><select id="gauge-${idx}"></select></div>
          <div class="field"><label>Flange</label><select id="flange-${idx}"></select></div>
        </div>
        <div class="grid-3" style="margin-top:8px">
          <div class="field"><label>Quantity</label><input id="qty-${idx}" type="number" min="1" step="1" value="1"></div>
          <div class="field"><label>Feet</label><input id="feet-${idx}" type="number" min="0" step="1" value="0"></div>
          <div class="field"><label>Inches</label><input id="inches-${idx}" type="number" min="0" max="11" step="1" value="0"></div>
        </div>
        <div class="result" id="result-${idx}" hidden>
          <div class="stat"><div class="k">Total Inches (line)</div><div class="v" id="rInches-${idx}">–</div></div>
          <div class="stat"><div class="k">Cost / Inch</div><div class="v" id="rCpi-${idx}">–</div></div>
          <div class="stat"><div class="k">Extended</div><div class="v" id="rExt-${idx}">–</div></div>
          <div class="stat"><div class="k">Source</div><div class="v" id="rSrc-${idx}">Sheet</div></div>
        </div>
      `;
      wrap.appendChild(row);

      // Fill dropdowns from cached options
      const fill = (sel, items) => {
        sel.innerHTML = '';
        items.forEach(v => {
          const o = document.createElement('option');
          o.value = o.textContent = v;
          sel.appendChild(o);
        });
      };
      fill($('component-'+idx), cachedOptions.components);
      fill($('color-'+idx),     cachedOptions.colors);
      fill($('gauge-'+idx),     cachedOptions.gauges);
      fill($('flange-'+idx),    cachedOptions.flanges);

      // Handlers
      qs(row,'[data-calc-one]').addEventListener('click',()=>calculateOne(idx));
      qs(row,'[data-remove]').addEventListener('click',()=>removeLine(idx));
    }

    function removeLine(idx){
      const el = qs($('linesContainer'), `section[data-idx="${idx}"]`);
      if (el) el.remove();
      extValues[idx-1] = 0;  // zero this line’s contribution
      updateTotals();
      renderLiveSummary(buildSummaryRows());
    }

    function addLine(){
      const countNow = document.querySelectorAll('#linesContainer section.row').length;
      if (countNow >= MAX_LINES) { setMsg('Max lines reached', false); return; }
      lineCount = Math.max(lineCount, countNow) + 1;
      extValues[lineCount-1] = 0;
      renderLine(lineCount);
      renderLiveSummary(buildSummaryRows());
    }

    // ----- load options once -----
    async function loadOptions(){
      try{
        setMsg('Loading options…');
        const data = await fetchJSON(WEB_APP_URL + '?fn=options&t=' + Date.now());
        cachedOptions = {
          components: data.components || [],
          colors:     data.colors || [],
          gauges:     data.gauges || [],
          flanges:    data.flanges || []
        };
        // if first load and no lines yet, add one
        if (document.querySelectorAll('#linesContainer section.row').length === 0) {
          lineCount = 0; extValues = [];
          addLine();
        }
        setMsg('Options loaded.', true);
      }catch(err){ setMsg(err.message, false); }
    }

    // read one line + determine if filled
    function readLine(i){
      const component = $('component-'+i)?.value ?? '';
      const color     = $('color-'+i)?.value ?? '';
      const gauge     = $('gauge-'+i)?.value ?? '';
      const flange    = $('flange-'+i)?.value ?? '';
      const qty       = $('qty-'+i)?.value || '1';
      const feet      = $('feet-'+i)?.value || '0';
      const inches    = $('inches-'+i)?.value || '0';
      const ftNum     = Number(feet)||0, inNum = Number(inches)||0, qNum = Number(qty)||0;
      const filled    = component && color && gauge && flange && qNum>0 && (ftNum>0 || inNum>0);
      return { i, component, color, gauge, flange, qty, feet, inches, filled };
    }

    // single-line calc (GET)
    async function calculateOne(i){
      try{
        const line = readLine(i);
        if (!line.filled){
          extValues[i-1] = 0; updateTotals();
          $('result-'+i).hidden = false;
          $('rInches-'+i).textContent = '–';
          $('rCpi-'+i).textContent    = '–';
          $('rExt-'+i).textContent    = '$0.00';
          $('rSrc-'+i).textContent    = 'Sheet';
          setMsg(`Line ${i} is empty — skipped.`, true);
          renderLiveSummary(buildSummaryRows());
          return;
        }
        setMsg('Calculating line ' + i + '…');
        const params = new URLSearchParams({
          fn:'price',
          component: line.component,
          color:     line.color,
          gauge:     line.gauge,
          flange:    line.flange,
          qty:       line.qty,
          feet:      line.feet,
          inches:    line.inches
        });
        const data = await fetchJSON(WEB_APP_URL + '?' + params.toString() + '&t=' + Date.now());
        $('rInches-'+i).textContent = Number(data.totalInches).toLocaleString();
        $('rCpi-'+i).textContent    = '$' + Number(data.costPerInch).toFixed(4);
        const ext = Number(data.extended) || 0;
        $('rExt-'+i).textContent = '$' + ext.toFixed(2);
        $('rSrc-'+i).textContent = data.key || 'Sheet';
        $('result-'+i).hidden    = false;
        extValues[i-1] = ext; updateTotals();
        renderLiveSummary(buildSummaryRows());
        setMsg('Ready.', true);
      }catch(err){
        extValues[i-1] = 0; updateTotals();
        setMsg(err.message, false);
      }
    }

    // Calculate ALL (POST), skipping blanks, with fallback
    async function calculateAll(){
      const btn = $('calcAllBtn');
      try{
        btn.disabled = true; btn.textContent = 'Calculating…';
        setMsg('Calculating all lines…');

        // Determine current number of rendered rows
        const rows = Array.from(document.querySelectorAll('#linesContainer section.row'));
        const ids = rows.map(r => Number(r.dataset.idx)).filter(Boolean);
        if (ids.length === 0){ setMsg('No rows found.', false); return; }

        const filled = []; const mapIdx = [];
        ids.forEach(i => {
          const ln = readLine(i);
          if (ln.filled){ filled.push(ln); mapIdx.push(i); } else { extValues[i-1] = 0; }
        });

        if (filled.length === 0){
          updateTotals(); renderLiveSummary([]); setMsg('No filled lines to calculate.', true);
          return;
        }

        // Try fast POST
        let data;
        try{
          data = await postJSON(WEB_APP_URL, {
            fn: 'price_batch',
            lines: filled.map(({component,color,gauge,flange,qty,feet,inches}) => ({
              component,
              color,
              gauge,
              flange,
              qty,
              feet,
              inches
            })),
            t: Date.now()
          });
        }catch(e){
          console.warn('Batch POST failed, falling back to per-line GET. Reason:', e);
          // Fallback — do individual GETs
          data = { lines: [] };
          for (const ln of filled){
            const params = new URLSearchParams({
              fn:'price',
              component: ln.component,
              color:     ln.color,
              gauge:     ln.gauge,
              flange:    ln.flange,
              qty:       ln.qty,
              feet:      ln.feet,
              inches:    ln.inches
            });
            try{
              const one = await fetchJSON(WEB_APP_URL + '?' + params.toString() + '&t=' + Date.now());
              data.lines.push(one);
              await delay(60); // gentle pacing
            }catch(errLine){
              data.lines.push({ error: String(errLine), key: `${ln.component}|${ln.color}|${ln.gauge}|${ln.flange}` });
            }
          }
        }

        // Update each filled row
        (data.lines || []).forEach((r, idx) => {
          const i = mapIdx[idx];
          if (r.error){
            $('rInches-'+i).textContent = '–';
            $('rCpi-'+i).textContent    = '–';
            $('rExt-'+i).textContent    = '$0.00';
            $('rSrc-'+i).textContent    = r.key || 'Sheet';
            $('result-'+i).hidden       = false;
            extValues[i-1] = 0;
          } else {
            $('rInches-'+i).textContent = Number(r.totalInches).toLocaleString();
            $('rCpi-'+i).textContent    = '$' + Number(r.costPerInch).toFixed(4);
            $('rExt-'+i).textContent    = '$' + Number(r.extended).toFixed(2);
            $('rSrc-'+i).textContent    = r.key || 'Sheet';
            $('result-'+i).hidden       = false;
            extValues[i-1] = Number(r.extended) || 0;
          }
        });

        updateTotals();
        renderLiveSummary(buildSummaryRows());
        setMsg('Ready.', true);
      }catch(err){
        console.error(err);
        setMsg(String(err), false);
      }finally{
        btn.disabled = false; btn.textContent = 'Calculate All';
      }
    }

    // ---- Print helpers ----
    function fmtMoney(n){ return '$' + (Number(n)||0).toFixed(2); }
    function todayISO(){
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }
    function buildPrintHtml(rows, subtotal){
      const logo = 'LOGO_URL'; // replace if you want the logo on the print
      const head = `
<!DOCTYPE html><html><head>
<meta charset="utf-8"><title>Gulf Coast • Estimate ${todayISO()}</title>
<style>
  body{font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#000;padding:16px}
  .top{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .top img{height:44px}
  h2{margin:0 0 4px 0;font-size:20px}
  .meta{color:#333;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:13px}
  th{background:#f2f6fb}
  td.num{text-align:right}
  .subtotal{margin-top:10px;text-align:right;font-weight:700;font-size:16px}
  .note{margin-top:12px;font-size:12px;color:#444}
  @page { margin:16mm }
</style>
</head><body>
<div class="top">
  ${logo && logo!=='LOGO_URL' ? `<img src="${logo}" alt="Gulf Coast">` : ''}
  <div>
    <h2>Gulf Coast • Internal Cost Estimate</h2>
    <div class="meta">Generated: ${new Date().toLocaleString()}</div>
  </div>
</div>
<table>
  <thead>
    <tr>
      <th>#</th><th>Component</th><th>Color</th><th>Gauge</th><th>Flange</th>
      <th class="num">Qty</th><th class="num">Feet</th><th class="num">Inches</th>
      <th class="num">Total Inches</th><th class="num">Extended</th>
    </tr>
  </thead>
  <tbody>
`;
      const body = rows.map(r => `
  <tr>
    <td>${r.i}</td>
    <td>${r.component||''}</td>
    <td>${r.color||''}</td>
    <td>${r.gauge||''}</td>
    <td>${r.flange||''}</td>
    <td class="num">${r.qty||0}</td>
    <td class="num">${r.feet||0}</td>
    <td class="num">${r.inches||0}</td>
    <td class="num">${Number(r.totalInches||0).toLocaleString()}</td>
    <td class="num">${fmtMoney(r.extended||0)}</td>
  </tr>`).join('');
      const tail = `
  </tbody>
</table>
<div class="subtotal">Subtotal: ${fmtMoney(subtotal)}</div>
<div class="note">For internal use only. Pricing sourced live from a hidden price table in Google Sheets.</div>
<script>window.onload = () => window.print();<\/script>
</body></html>`;
      return head + body + tail;
    }
    function computeSubtotal(){
      return extValues.reduce((a,b)=>a + (Number(b)||0), 0);
    }
    function buildSummaryRows(){
      const rows = [];
      const rendered = Array.from(document.querySelectorAll('#linesContainer section.row'));
      const ids = rendered.map(r => Number(r.dataset.idx)).filter(Boolean);
      ids.forEach(i => {
        const ln = readLine(i);
        const ext = Number(extValues[i-1])||0;
        if (!ln.filled && ext===0) return;
        const totalInches = (Number(ln.qty)||0) * (12*(Number(ln.feet)||0) + (Number(ln.inches)||0));
        rows.push({
          i,
          component: ln.component,
          color:     ln.color,
          gauge:     ln.gauge,
          flange:    ln.flange,
          qty:       ln.qty,
          feet:      ln.feet,
          inches:    ln.inches,
          totalInches,
          extended:  ext
        });
      });
      return rows;
    }
    function printSelections(){
      const rows = buildSummaryRows();
      if (!rows.length){ setMsg('Nothing to print yet.', false); return; }
      const html = buildPrintHtml(rows, computeSubtotal());
      const w = window.open('', '_blank');
      w.document.open(); w.document.write(html); w.document.close();
    }

    // public sheet B–K viewer
    async function loadSheetLines(){
      try{
        setMsg('Loading lines…');
        const data = await fetchJSON(WEB_APP_URL + '?fn=lines&t=' + Date.now());
        const tbody = $('sheetLinesBody'); tbody.innerHTML = '';
        const rows = (data && data.rows) || [];
        rows.forEach(r => {
          const [priceCode, comp, col, g, flange, qty, ft, inch, total, est] = r;
          const tr = document.createElement('tr');
          const td = (t,c)=>{ const d=document.createElement('td'); d.textContent = (t??''); if(c) d.className=c; return d; };
          tr.appendChild(td(priceCode));
          tr.appendChild(td(comp));
          tr.appendChild(td(col));
          tr.appendChild(td(g));
          tr.appendChild(td(flange));
          tr.appendChild(td(qty,'num'));
          tr.appendChild(td(ft,'num'));
          tr.appendChild(td(inch,'num'));
          tr.appendChild(td(total,'num'));
          tr.appendChild(td(typeof est==='number' ? ('$'+Number(est).toFixed(2)) : est,'num'));
          tbody.appendChild(tr);
        });
        setMsg(`Loaded ${rows.length} line(s).`, true);
      }catch(err){ setMsg(err.message, false); }
    }

    // boot
    (async function init(){
      await loadOptions();         // loads options and adds first line
      updateTotals();
      renderLiveSummary([]);
      loadSheetLines();
    })();

    // header buttons
    $('reloadOptionsBtn').addEventListener('click', loadOptions);
    $('addLineBtn').addEventListener('click', addLine);
    $('calcAllBtn').addEventListener('click', calculateAll);
    $('loadSheetLinesBtn').addEventListener('click', loadSheetLines);
    $('printBtn').addEventListener('click', printSelections);

    // live summary renderer
    function renderLiveSummary(rows){
      const tbody = $('liveSummaryBody'); tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const td = (t,c)=>{ const d=document.createElement('td'); d.textContent=(t??''); if(c) d.className=c; return d; };
        tr.appendChild(td(r.i));
        tr.appendChild(td(r.component));
        tr.appendChild(td(r.color));
        tr.appendChild(td(r.gauge));
        tr.appendChild(td(r.flange));
        tr.appendChild(td(r.qty,'num'));
        tr.appendChild(td(r.feet,'num'));
        tr.appendChild(td(r.inches,'num'));
        tr.appendChild(td(Number(r.totalInches).toLocaleString(),'num'));
        tr.appendChild(td('$'+(Number(r.extended)||0).toFixed(2),'num'));
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
